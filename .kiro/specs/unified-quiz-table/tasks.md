# План реализации объединения таблиц квиза

- [x] 1. Создать новый класс UnifiedGoogleSheetsDB
  - Создать класс UnifiedGoogleSheetsDB наследующий от GoogleSheetsDB
  - Реализовать метод _get_sheet_name() для выбора листа по полу
  - Добавить валидацию пола пользователя с fallback на "female"
  - _Требования: 2.1, 4.1, 6.1_

- [x] 2. Обновить методы получения данных с поддержкой пола
  - Модифицировать get_question() для работы с листами Questions_Female/Male
  - Обновить get_answers() для работы с листами Answers_Female/Male
  - Изменить get_archetype_result() для работы с листами Archetypes_Female/Male
  - Обновить get_all_archetypes() для работы с соответствующими листами
  - _Требования: 3.1, 3.2, 3.3, 3.4_

- [x] 3. Добавить простую обработку ошибок
  - Добавить try/catch для случаев отсутствия листов
  - Добавить логирование ошибок доступа к листам
  - Показать понятные сообщения об ошибках пользователю
  - _Требования: 6.3, 6.4_

- [x] 4. Обновить инициализацию БД в handlers.py
  - Заменить GenderBasedSheetsManager на UnifiedGoogleSheetsDB
  - Упростить инициализацию до одного экземпляра БД
  - Убрать логику создания отдельных БД для разных полов
  - _Требования: 4.1, 6.2_

- [x] 5. Обновить все вызовы методов БД для передачи пола
  - Модифицировать send_question() для передачи user_gender
  - Обновить instructions_handler для передачи пола пользователя
  - Изменить quiz_start_handler для работы с новой БД
  - Обновить show_results_handler для получения архетипов по полу
  - _Требования: 3.1, 3.2, 3.3, 3.4_

- [x] 6. Упростить конфигурацию окружения
  - Удалить использование SPREADSHEET_KEY_FEMALE и SPREADSHEET_KEY_MALE
  - Оставить только SPREADSHEET_KEY для новой объединенной таблицы
  - Добавить логирование предупреждений если старые переменные все еще присутствуют
  - _Требования: 4.1, 4.2, 4.3_

- [x] 7. Обновить .env.example с новой конфигурацией
  - Удалить примеры SPREADSHEET_KEY_FEMALE и SPREADSHEET_KEY_MALE
  - Оставить только SPREADSHEET_KEY с комментарием об объединенной таблице
  - Добавить комментарии о структуре новой таблицы
  - _Требования: 4.1_

- [x] 8. Создать инструкцию по подготовке объединенной таблицы
  - Обновить docs/google-sheets-structure.md с новой структурой листов
  - Добавить инструкцию по переименованию существующих листов в *_Female
  - Добавить инструкцию по копированию данных из мужской таблицы в новые листы *_Male
  - Документировать финальную структуру с 7 листами
  - _Требования: 1.1, 5.1, 5.2_

- [x] 9. Добавить тесты для новой логики
  - Написать тесты для метода _get_sheet_name()
  - Добавить тесты для валидации пола пользователя
  - Протестировать работу с Config листом (общим для всех)
  - Протестировать работу с листами *_Female и *_Male
  - _Требования: 6.1, 6.2, 6.3_